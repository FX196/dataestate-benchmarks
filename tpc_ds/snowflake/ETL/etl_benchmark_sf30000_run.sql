ALTER WAREHOUSE WH_2XL resume
;
ALTER SESSION SET USE_CACHED_RESULT = FALSE
;
/* -----------------------
        START - sf30000
----------------------- */

ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 0 - step 1 - drop database'  ; DROP DATABASE IF EXISTS etl_sf30000 CASCADE;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 0 - step 2 - create database'; CREATE DATABASE IF NOT EXISTS etl_sf30000;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 0 - step 3 - use database'   ; USE etl_sf30000;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 0 - step 4 - use schema'     ; USE SCHEMA etl_sf30000.public;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 0 - step 5 - drop table'     ; DROP TABLE IF EXISTS etl_sf30000.public.store_sales_denorm;

/* -----------------------
      ETL STEP 1 
----------------------- */
ALTER SESSION SET QUERY_TAG = 'etl sf30000_cl_large_ac - write 1 - create table'; 
create or replace TABLE etl_sf3000_cl_large_ac.public.store_sales_denorm cluster by (ss_sold_date_sk)( SS_SOLD_DATE_SK NUMBER(38,0), SS_SOLD_TIME_SK NUMBER(38,0), SS_ITEM_SK NUMBER(38,0), SS_CUSTOMER_SK NUMBER(38,0), SS_CDEMO_SK NUMBER(38,0), SS_HDEMO_SK NUMBER(38,0), SS_ADDR_SK NUMBER(38,0), SS_STORE_SK NUMBER(38,0), SS_PROMO_SK NUMBER(38,0), SS_TICKET_NUMBER NUMBER(38,0), SS_QUANTITY NUMBER(38,0), SS_WHOLESALE_COST NUMBER(7,2), SS_LIST_PRICE NUMBER(7,2), SS_SALES_PRICE NUMBER(7,2), SS_EXT_DISCOUNT_AMT NUMBER(7,2), SS_EXT_SALES_PRICE NUMBER(7,2), SS_EXT_WHOLESALE_COST NUMBER(7,2), SS_EXT_LIST_PRICE NUMBER(7,2), SS_EXT_TAX NUMBER(7,2), SS_COUPON_AMT NUMBER(7,2), SS_NET_PAID NUMBER(7,2), SS_NET_PAID_INC_TAX NUMBER(7,2), SS_NET_PROFIT NUMBER(7,2), D_DATE_SK NUMBER(38,0), D_DATE_ID VARCHAR(16), D_DATE DATE, D_MONTH_SEQ NUMBER(38,0), D_WEEK_SEQ NUMBER(38,0), D_QUARTER_SEQ NUMBER(38,0), D_YEAR NUMBER(38,0), D_DOW NUMBER(38,0), D_MOY NUMBER(38,0), D_DOM NUMBER(38,0), D_QOY NUMBER(38,0), D_FY_YEAR NUMBER(38,0), D_FY_QUARTER_SEQ NUMBER(38,0), D_FY_WEEK_SEQ NUMBER(38,0), D_DAY_NAME VARCHAR(9), D_QUARTER_NAME VARCHAR(6), D_HOLIDAY VARCHAR(1), D_WEEKEND VARCHAR(1), D_FOLLOWING_HOLIDAY VARCHAR(1), D_FIRST_DOM NUMBER(38,0), D_LAST_DOM NUMBER(38,0), D_SAME_DAY_LY NUMBER(38,0), D_SAME_DAY_LQ NUMBER(38,0), D_CURRENT_DAY VARCHAR(1), D_CURRENT_WEEK VARCHAR(1), D_CURRENT_MONTH VARCHAR(1), D_CURRENT_QUARTER VARCHAR(1), D_CURRENT_YEAR VARCHAR(1), T_TIME_SK NUMBER(38,0), T_TIME_ID VARCHAR(16), T_TIME NUMBER(38,0), T_HOUR NUMBER(38,0), T_MINUTE NUMBER(38,0), T_SECOND NUMBER(38,0), T_AM_PM VARCHAR(2), T_SHIFT VARCHAR(20), T_SUB_SHIFT VARCHAR(20), T_MEAL_TIME VARCHAR(20), C_CUSTOMER_SK NUMBER(38,0), C_CUSTOMER_ID VARCHAR(16), C_CURRENT_CDEMO_SK NUMBER(38,0), C_CURRENT_HDEMO_SK NUMBER(38,0), C_CURRENT_ADDR_SK NUMBER(38,0), C_FIRST_SHIPTO_DATE_SK NUMBER(38,0), C_FIRST_SALES_DATE_SK NUMBER(38,0), C_SALUTATION VARCHAR(10), C_FIRST_NAME VARCHAR(20), C_LAST_NAME VARCHAR(30), C_PREFERRED_CUST_FLAG VARCHAR(1), C_BIRTH_DAY NUMBER(38,0), C_BIRTH_MONTH NUMBER(38,0), C_BIRTH_YEAR NUMBER(38,0), C_BIRTH_COUNTRY VARCHAR(20), C_LOGIN VARCHAR(13), C_EMAIL_ADDRESS VARCHAR(50), C_LAST_REVIEW_DATE VARCHAR(10), CD_DEMO_SK NUMBER(38,0), CD_GENDER VARCHAR(1), CD_MARITAL_STATUS VARCHAR(1), CD_EDUCATION_STATUS VARCHAR(20), CD_PURCHASE_ESTIMATE NUMBER(38,0), CD_CREDIT_RATING VARCHAR(10), CD_DEP_COUNT NUMBER(38,0), CD_DEP_EMPLOYED_COUNT NUMBER(38,0), CD_DEP_COLLEGE_COUNT NUMBER(38,0), HD_DEMO_SK NUMBER(38,0), HD_INCOME_BAND_SK NUMBER(38,0), HD_BUY_POTENTIAL VARCHAR(15), HD_DEP_COUNT NUMBER(38,0), HD_VEHICLE_COUNT NUMBER(38,0), CA_ADDRESS_SK NUMBER(38,0), CA_ADDRESS_ID VARCHAR(16), CA_STREET_NUMBER VARCHAR(10), CA_STREET_NAME VARCHAR(60), CA_STREET_TYPE VARCHAR(15), CA_SUITE_NUMBER VARCHAR(10), CA_CITY VARCHAR(60), CA_COUNTY VARCHAR(30), CA_STATE VARCHAR(2), CA_ZIP VARCHAR(10), CA_COUNTRY VARCHAR(20), CA_GMT_OFFSET NUMBER(5,2), CA_LOCATION_TYPE VARCHAR(20), S_STORE_SK NUMBER(38,0), S_STORE_ID VARCHAR(16), S_REC_START_DATE DATE, S_REC_END_DATE DATE, S_CLOSED_DATE_SK NUMBER(38,0), S_STORE_NAME VARCHAR(50), S_NUMBER_EMPLOYEES NUMBER(38,0), S_FLOOR_SPACE NUMBER(38,0), S_HOURS VARCHAR(20), S_MANAGER VARCHAR(40), S_MARKET_ID NUMBER(38,0), S_GEOGRAPHY_CLASS VARCHAR(100), S_MARKET_DESC VARCHAR(100), S_MARKET_MANAGER VARCHAR(40), S_DIVISION_ID NUMBER(38,0), S_DIVISION_NAME VARCHAR(50), S_COMPANY_ID NUMBER(38,0), S_COMPANY_NAME VARCHAR(50), S_STREET_NUMBER VARCHAR(10), S_STREET_NAME VARCHAR(60), S_STREET_TYPE VARCHAR(15), S_SUITE_NUMBER VARCHAR(10), S_CITY VARCHAR(60), S_COUNTY VARCHAR(30), S_STATE VARCHAR(2), S_ZIP VARCHAR(10), S_COUNTRY VARCHAR(20), S_GMT_OFFSET NUMBER(5,2), S_TAX_PRECENTAGE NUMBER(5,2), P_PROMO_SK NUMBER(38,0), P_PROMO_ID VARCHAR(16), P_START_DATE_SK NUMBER(38,0), P_END_DATE_SK NUMBER(38,0), P_ITEM_SK NUMBER(38,0), P_COST NUMBER(15,2), P_RESPONSE_TARGET NUMBER(38,0), P_PROMO_NAME VARCHAR(50), P_CHANNEL_DMAIL VARCHAR(1), P_CHANNEL_EMAIL VARCHAR(1), P_CHANNEL_CATALOG VARCHAR(1), P_CHANNEL_TV VARCHAR(1), P_CHANNEL_RADIO VARCHAR(1), P_CHANNEL_PRESS VARCHAR(1), P_CHANNEL_EVENT VARCHAR(1), P_CHANNEL_DEMO VARCHAR(1), P_CHANNEL_DETAILS VARCHAR(100), P_PURPOSE VARCHAR(15), P_DISCOUNT_ACTIVE VARCHAR(1), I_ITEM_SK NUMBER(38,0), I_ITEM_ID VARCHAR(16), I_REC_START_DATE DATE, I_REC_END_DATE DATE, I_ITEM_DESC VARCHAR(200), I_CURRENT_PRICE NUMBER(7,2), I_WHOLESALE_COST NUMBER(7,2), I_BRAND_ID NUMBER(38,0), I_BRAND VARCHAR(50), I_CLASS_ID NUMBER(38,0), I_CLASS VARCHAR(50), I_CATEGORY_ID NUMBER(38,0), I_CATEGORY VARCHAR(50), I_MANUFACT_ID NUMBER(38,0), I_MANUFACT VARCHAR(50), I_SIZE VARCHAR(20), I_FORMULATION VARCHAR(20), I_COLOR VARCHAR(20), I_UNITS VARCHAR(10), I_CONTAINER VARCHAR(10), I_MANAGER_ID NUMBER(38,0), I_PRODUCT_NAME VARCHAR(50) );
insert into etl_sf3000_cl_large_ac.public.store_sales_denorm SELECT * FROM etlprep_sf3000_nocl.public.store_sales_denorm_start ;

ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q13 - iteration 1'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q19 - iteration 1'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q27 - iteration 1'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q28 - iteration 1'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q3  - iteration 1'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q36 - iteration 1'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q6  - iteration 1'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q7  - iteration 1'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q8  - iteration 1'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q9  - iteration 1'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q13 - iteration 2'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q19 - iteration 2'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q27 - iteration 2'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q28 - iteration 2'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q3  - iteration 2'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q36 - iteration 2'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q6  - iteration 2'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q7  - iteration 2'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q8  - iteration 2'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q9  - iteration 2'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q13 - iteration 3'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q19 - iteration 3'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q27 - iteration 3'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q28 - iteration 3'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q3  - iteration 3'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q36 - iteration 3'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q6  - iteration 3'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q7  - iteration 3'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q8  - iteration 3'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 1 - q9  - iteration 3'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;

/* -----------------------
      ETL STEP 2
----------------------- */
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 2 - upsert medium'; 
MERGE INTO etl_sf30000.public.store_sales_denorm AS a
USING etlprep_sf30000.public.store_sales_denorm_upsert AS b
   ON a.ss_sold_date_sk = b.ss_sold_date_sk
  AND a.ss_item_sk = b.ss_item_sk
  AND a.ss_ticket_number = b.ss_ticket_number
WHEN MATCHED THEN 
      UPDATE SET a.ss_sold_date_sk = b.ss_sold_date_sk, a.ss_sold_time_sk = b.ss_sold_time_sk, a.ss_item_sk = b.ss_item_sk, a.ss_customer_sk = b.ss_customer_sk, a.ss_cdemo_sk = b.ss_cdemo_sk, a.ss_hdemo_sk = b.ss_hdemo_sk, a.ss_addr_sk = b.ss_addr_sk, a.ss_store_sk = b.ss_store_sk, a.ss_promo_sk = b.ss_promo_sk, a.ss_ticket_number = b.ss_ticket_number, a.ss_quantity = b.ss_quantity, a.ss_wholesale_cost = b.ss_wholesale_cost, a.ss_list_price = b.ss_list_price, a.ss_sales_price = b.ss_sales_price, a.ss_ext_discount_amt = b.ss_ext_discount_amt, a.ss_ext_sales_price = b.ss_ext_sales_price, a.ss_ext_wholesale_cost = b.ss_ext_wholesale_cost, a.ss_ext_list_price = b.ss_ext_list_price, a.ss_ext_tax = b.ss_ext_tax, a.ss_coupon_amt = b.ss_coupon_amt, a.ss_net_paid = b.ss_net_paid, a.ss_net_paid_inc_tax = b.ss_net_paid_inc_tax, a.ss_net_profit = b.ss_net_profit, a.d_date_sk = b.d_date_sk, a.d_date_id = b.d_date_id, a.d_date = b.d_date, a.d_month_seq = b.d_month_seq, a.d_week_seq = b.d_week_seq, a.d_quarter_seq = b.d_quarter_seq, a.d_year = b.d_year, a.d_dow = b.d_dow, a.d_moy = b.d_moy, a.d_dom = b.d_dom, a.d_qoy = b.d_qoy, a.d_fy_year = b.d_fy_year, a.d_fy_quarter_seq = b.d_fy_quarter_seq, a.d_fy_week_seq = b.d_fy_week_seq, a.d_day_name = b.d_day_name, a.d_quarter_name = b.d_quarter_name, a.d_holiday = b.d_holiday, a.d_weekend = b.d_weekend, a.d_following_holiday = b.d_following_holiday, a.d_first_dom = b.d_first_dom, a.d_last_dom = b.d_last_dom, a.d_same_day_ly = b.d_same_day_ly, a.d_same_day_lq = b.d_same_day_lq, a.d_current_day = b.d_current_day, a.d_current_week = b.d_current_week, a.d_current_month = b.d_current_month, a.d_current_quarter = b.d_current_quarter, a.d_current_year = b.d_current_year, a.t_time_sk = b.t_time_sk, a.t_time_id = b.t_time_id, a.t_time = b.t_time, a.t_hour = b.t_hour, a.t_minute = b.t_minute, a.t_second = b.t_second, a.t_am_pm = b.t_am_pm, a.t_shift = b.t_shift, a.t_sub_shift = b.t_sub_shift, a.t_meal_time = b.t_meal_time, a.c_customer_sk = b.c_customer_sk, a.c_customer_id = b.c_customer_id, a.c_current_cdemo_sk = b.c_current_cdemo_sk, a.c_current_hdemo_sk = b.c_current_hdemo_sk, a.c_current_addr_sk = b.c_current_addr_sk, a.c_first_shipto_date_sk = b.c_first_shipto_date_sk, a.c_first_sales_date_sk = b.c_first_sales_date_sk, a.c_salutation = b.c_salutation, a.c_first_name = b.c_first_name, a.c_last_name = b.c_last_name, a.c_preferred_cust_flag = b.c_preferred_cust_flag, a.c_birth_day = b.c_birth_day, a.c_birth_month = b.c_birth_month, a.c_birth_year = b.c_birth_year, a.c_birth_country = b.c_birth_country, a.c_login = b.c_login, a.c_email_address = b.c_email_address, a.c_last_review_date = b.c_last_review_date, a.cd_demo_sk = b.cd_demo_sk, a.cd_gender = b.cd_gender, a.cd_marital_status = b.cd_marital_status, a.cd_education_status = b.cd_education_status, a.cd_purchase_estimate = b.cd_purchase_estimate, a.cd_credit_rating = b.cd_credit_rating, a.cd_dep_count = b.cd_dep_count, a.cd_dep_employed_count = b.cd_dep_employed_count, a.cd_dep_college_count = b.cd_dep_college_count, a.hd_demo_sk = b.hd_demo_sk, a.hd_income_band_sk = b.hd_income_band_sk, a.hd_buy_potential = b.hd_buy_potential, a.hd_dep_count = b.hd_dep_count, a.hd_vehicle_count = b.hd_vehicle_count, a.ca_address_sk = b.ca_address_sk, a.ca_address_id = b.ca_address_id, a.ca_street_number = b.ca_street_number, a.ca_street_name = b.ca_street_name, a.ca_street_type = b.ca_street_type, a.ca_suite_number = b.ca_suite_number, a.ca_city = b.ca_city, a.ca_county = b.ca_county, a.ca_state = b.ca_state, a.ca_zip = b.ca_zip, a.ca_country = b.ca_country, a.ca_gmt_offset = b.ca_gmt_offset, a.ca_location_type = b.ca_location_type, a.s_store_sk = b.s_store_sk, a.s_store_id = b.s_store_id, a.s_rec_start_date = b.s_rec_start_date, a.s_rec_end_date = b.s_rec_end_date, a.s_closed_date_sk = b.s_closed_date_sk, a.s_store_name = b.s_store_name, a.s_number_employees = b.s_number_employees, a.s_floor_space = b.s_floor_space, a.s_hours = b.s_hours, a.s_manager = b.s_manager, a.s_market_id = b.s_market_id, a.s_geography_class = b.s_geography_class, a.s_market_desc = b.s_market_desc, a.s_market_manager = b.s_market_manager, a.s_division_id = b.s_division_id, a.s_division_name = b.s_division_name, a.s_company_id = b.s_company_id, a.s_company_name = b.s_company_name, a.s_street_number = b.s_street_number, a.s_street_name = b.s_street_name, a.s_street_type = b.s_street_type, a.s_suite_number = b.s_suite_number, a.s_city = b.s_city, a.s_county = b.s_county, a.s_state = b.s_state, a.s_zip = b.s_zip, a.s_country = b.s_country, a.s_gmt_offset = b.s_gmt_offset, a.s_tax_precentage = b.s_tax_precentage, a.p_promo_sk = b.p_promo_sk, a.p_promo_id = b.p_promo_id, a.p_start_date_sk = b.p_start_date_sk, a.p_end_date_sk = b.p_end_date_sk, a.p_item_sk = b.p_item_sk, a.p_cost = b.p_cost, a.p_response_target = b.p_response_target, a.p_promo_name = b.p_promo_name, a.p_channel_dmail = b.p_channel_dmail, a.p_channel_email = b.p_channel_email, a.p_channel_catalog = b.p_channel_catalog, a.p_channel_tv = b.p_channel_tv, a.p_channel_radio = b.p_channel_radio, a.p_channel_press = b.p_channel_press, a.p_channel_event = b.p_channel_event, a.p_channel_demo = b.p_channel_demo, a.p_channel_details = b.p_channel_details, a.p_purpose = b.p_purpose, a.p_discount_active = b.p_discount_active, a.i_item_sk = b.i_item_sk, a.i_item_id = b.i_item_id, a.i_rec_start_date = b.i_rec_start_date, a.i_rec_end_date = b.i_rec_end_date, a.i_item_desc = b.i_item_desc, a.i_current_price = b.i_current_price, a.i_wholesale_cost = b.i_wholesale_cost, a.i_brand_id = b.i_brand_id, a.i_brand = b.i_brand, a.i_class_id = b.i_class_id, a.i_class = b.i_class, a.i_category_id = b.i_category_id, a.i_category = b.i_category, a.i_manufact_id = b.i_manufact_id, a.i_manufact = b.i_manufact, a.i_size = b.i_size, a.i_formulation = b.i_formulation, a.i_color = b.i_color, a.i_units = b.i_units, a.i_container = b.i_container, a.i_manager_id = b.i_manager_id, a.i_product_name = b.i_product_name
WHEN NOT MATCHED THEN 
      INSERT VALUES( b.ss_sold_date_sk, b.ss_sold_time_sk, b.ss_item_sk, b.ss_customer_sk, b.ss_cdemo_sk, b.ss_hdemo_sk, b.ss_addr_sk, b.ss_store_sk, b.ss_promo_sk, b.ss_ticket_number, b.ss_quantity, b.ss_wholesale_cost, b.ss_list_price, b.ss_sales_price, b.ss_ext_discount_amt, b.ss_ext_sales_price, b.ss_ext_wholesale_cost, b.ss_ext_list_price, b.ss_ext_tax, b.ss_coupon_amt, b.ss_net_paid, b.ss_net_paid_inc_tax, b.ss_net_profit, b.d_date_sk, b.d_date_id, b.d_date, b.d_month_seq, b.d_week_seq, b.d_quarter_seq, b.d_year, b.d_dow, b.d_moy, b.d_dom, b.d_qoy, b.d_fy_year, b.d_fy_quarter_seq, b.d_fy_week_seq, b.d_day_name, b.d_quarter_name, b.d_holiday, b.d_weekend, b.d_following_holiday, b.d_first_dom, b.d_last_dom, b.d_same_day_ly, b.d_same_day_lq, b.d_current_day, b.d_current_week, b.d_current_month, b.d_current_quarter, b.d_current_year, b.t_time_sk, b.t_time_id, b.t_time, b.t_hour, b.t_minute, b.t_second, b.t_am_pm, b.t_shift, b.t_sub_shift, b.t_meal_time, b.c_customer_sk, b.c_customer_id, b.c_current_cdemo_sk, b.c_current_hdemo_sk, b.c_current_addr_sk, b.c_first_shipto_date_sk, b.c_first_sales_date_sk, b.c_salutation, b.c_first_name, b.c_last_name, b.c_preferred_cust_flag, b.c_birth_day, b.c_birth_month, b.c_birth_year, b.c_birth_country, b.c_login, b.c_email_address, b.c_last_review_date, b.cd_demo_sk, b.cd_gender, b.cd_marital_status, b.cd_education_status, b.cd_purchase_estimate, b.cd_credit_rating, b.cd_dep_count, b.cd_dep_employed_count, b.cd_dep_college_count, b.hd_demo_sk, b.hd_income_band_sk, b.hd_buy_potential, b.hd_dep_count, b.hd_vehicle_count, b.ca_address_sk, b.ca_address_id, b.ca_street_number, b.ca_street_name, b.ca_street_type, b.ca_suite_number, b.ca_city, b.ca_county, b.ca_state, b.ca_zip, b.ca_country, b.ca_gmt_offset, b.ca_location_type, b.s_store_sk, b.s_store_id, b.s_rec_start_date, b.s_rec_end_date, b.s_closed_date_sk, b.s_store_name, b.s_number_employees, b.s_floor_space, b.s_hours, b.s_manager, b.s_market_id, b.s_geography_class, b.s_market_desc, b.s_market_manager, b.s_division_id, b.s_division_name, b.s_company_id, b.s_company_name, b.s_street_number, b.s_street_name, b.s_street_type, b.s_suite_number, b.s_city, b.s_county, b.s_state, b.s_zip, b.s_country, b.s_gmt_offset, b.s_tax_precentage, b.p_promo_sk, b.p_promo_id, b.p_start_date_sk, b.p_end_date_sk, b.p_item_sk, b.p_cost, b.p_response_target, b.p_promo_name, b.p_channel_dmail, b.p_channel_email, b.p_channel_catalog, b.p_channel_tv, b.p_channel_radio, b.p_channel_press, b.p_channel_event, b.p_channel_demo, b.p_channel_details, b.p_purpose, b.p_discount_active, b.i_item_sk, b.i_item_id, b.i_rec_start_date, b.i_rec_end_date, b.i_item_desc, b.i_current_price, b.i_wholesale_cost, b.i_brand_id, b.i_brand, b.i_class_id, b.i_class, b.i_category_id, b.i_category, b.i_manufact_id, b.i_manufact, b.i_size, b.i_formulation, b.i_color, b.i_units, b.i_container, b.i_manager_id, b.i_product_name)
;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q13 - iteration 1'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q19 - iteration 1'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q27 - iteration 1'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q28 - iteration 1'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q3  - iteration 1'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q36 - iteration 1'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q6  - iteration 1'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q7  - iteration 1'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q8  - iteration 1'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q9  - iteration 1'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q13 - iteration 2'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q19 - iteration 2'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q27 - iteration 2'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q28 - iteration 2'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q3  - iteration 2'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q36 - iteration 2'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q6  - iteration 2'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q7  - iteration 2'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q8  - iteration 2'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q9  - iteration 2'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q13 - iteration 3'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q19 - iteration 3'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q27 - iteration 3'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q28 - iteration 3'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q3  - iteration 3'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q36 - iteration 3'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q6  - iteration 3'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q7  - iteration 3'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q8  - iteration 3'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 2 - q9  - iteration 3'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;

/* -----------------------
      ETL STEP 3 
----------------------- */
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 3 - delete x-small'; 
MERGE INTO etl_sf30000.public.store_sales_denorm AS a
USING etlprep_sf30000.public.store_sales_denorm_delete_xsmall AS b
   ON a.ss_sold_date_sk = b.ss_sold_date_sk
  AND a.ss_item_sk = b.ss_item_sk
  AND a. ss_ticket_number = b. ss_ticket_number
WHEN MATCHED THEN DELETE
;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q13 - iteration 1'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q19 - iteration 1'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q27 - iteration 1'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q28 - iteration 1'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q3  - iteration 1'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q36 - iteration 1'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q6  - iteration 1'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q7  - iteration 1'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q8  - iteration 1'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q9  - iteration 1'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q13 - iteration 2'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q19 - iteration 2'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q27 - iteration 2'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q28 - iteration 2'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q3  - iteration 2'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q36 - iteration 2'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q6  - iteration 2'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q7  - iteration 2'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q8  - iteration 2'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q9  - iteration 2'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q13 - iteration 3'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q19 - iteration 3'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q27 - iteration 3'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q28 - iteration 3'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q3  - iteration 3'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q36 - iteration 3'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q6  - iteration 3'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q7  - iteration 3'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q8  - iteration 3'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 3 - q9  - iteration 3'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;

/* -----------------------
      ETL STEP 4 
----------------------- */
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 4 - delete small'; 
MERGE INTO etl_sf30000.public.store_sales_denorm AS a
USING etlprep_sf30000.public.store_sales_denorm_delete_small AS b
   ON a.ss_sold_date_sk = b.ss_sold_date_sk
  AND a.ss_item_sk = b.ss_item_sk
  AND a. ss_ticket_number = b. ss_ticket_number
WHEN MATCHED THEN DELETE
;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q13 - iteration 1'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q19 - iteration 1'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q27 - iteration 1'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q28 - iteration 1'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q3  - iteration 1'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q36 - iteration 1'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q6  - iteration 1'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q7  - iteration 1'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q8  - iteration 1'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q9  - iteration 1'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q13 - iteration 2'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q19 - iteration 2'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q27 - iteration 2'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q28 - iteration 2'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q3  - iteration 2'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q36 - iteration 2'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q6  - iteration 2'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q7  - iteration 2'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q8  - iteration 2'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q9  - iteration 2'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q13 - iteration 3'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q19 - iteration 3'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q27 - iteration 3'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q28 - iteration 3'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q3  - iteration 3'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q36 - iteration 3'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q6  - iteration 3'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q7  - iteration 3'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q8  - iteration 3'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 4 - q9  - iteration 3'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;

/* -----------------------
      ETL STEP 5 
----------------------- */
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 5 - delete medium'; 
MERGE INTO etl_sf30000.public.store_sales_denorm AS a
USING etlprep_sf30000.public.store_sales_denorm_delete_medium AS b
   ON a.ss_sold_date_sk = b.ss_sold_date_sk
  AND a.ss_item_sk = b.ss_item_sk
  AND a. ss_ticket_number = b. ss_ticket_number
WHEN MATCHED THEN DELETE
;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q13 - iteration 1'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q19 - iteration 1'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q27 - iteration 1'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q28 - iteration 1'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q3  - iteration 1'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q36 - iteration 1'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q6  - iteration 1'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q7  - iteration 1'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q8  - iteration 1'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q9  - iteration 1'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q13 - iteration 2'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q19 - iteration 2'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q27 - iteration 2'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q28 - iteration 2'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q3  - iteration 2'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q36 - iteration 2'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q6  - iteration 2'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q7  - iteration 2'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q8  - iteration 2'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q9  - iteration 2'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q13 - iteration 3'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q19 - iteration 3'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q27 - iteration 3'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q28 - iteration 3'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q3  - iteration 3'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q36 - iteration 3'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q6  - iteration 3'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q7  - iteration 3'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q8  - iteration 3'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 5 - q9  - iteration 3'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;

/* -----------------------
      ETL STEP 6
----------------------- */
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 6 - delete gdpr'; 
DELETE FROM etl_sf30000.public.store_sales_denorm WHERE c_customer_sk = 221580
;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q13 - iteration 1'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q19 - iteration 1'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q27 - iteration 1'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q28 - iteration 1'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q3  - iteration 1'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q36 - iteration 1'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q6  - iteration 1'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q7  - iteration 1'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q8  - iteration 1'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q9  - iteration 1'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q13 - iteration 2'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q19 - iteration 2'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q27 - iteration 2'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q28 - iteration 2'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q3  - iteration 2'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q36 - iteration 2'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q6  - iteration 2'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q7  - iteration 2'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q8  - iteration 2'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q9  - iteration 2'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q13 - iteration 3'; SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2001 AND ((cd_marital_status = 'D' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 ) OR (cd_marital_status = 'S' AND cd_education_status = 'Secondary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 ) OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 )) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'IL', 'MN') AND ss_net_profit BETWEEN 100 AND 200 ) OR (ca_country = 'United States' AND ca_state IN ('OH', 'MT', 'NM') AND ss_net_profit BETWEEN 150 AND 300 ) OR (ca_country = 'United States' AND ca_state IN ('TX', 'MO', 'MI') AND ss_net_profit BETWEEN 50 AND 250 )) ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q19 - iteration 3'; SELECT i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) ext_price FROM etl_sf30000.public.store_sales_denorm WHERE i_manager_id=7 AND d_moy=11 AND d_year=1999 AND substr(ca_zip, 1, 5) <> substr(s_zip, 1, 5) GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q27 - iteration 3'; SELECT i_item_id, s_state, GROUPING (s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND d_year = 2002 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN') GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q28 - iteration 3'; SELECT * FROM ( SELECT AVG(ss_list_price) B1_LP, COUNT(ss_list_price) B1_CNT, COUNT(DISTINCT ss_list_price) B1_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 11 AND 11+10 OR ss_coupon_amt BETWEEN 460 AND 460+1000 OR ss_wholesale_cost BETWEEN 14 AND 14+20) ) B1, ( SELECT AVG(ss_list_price) B2_LP, COUNT(ss_list_price) B2_CNT, COUNT(DISTINCT ss_list_price) B2_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 91 AND 91+10 OR ss_coupon_amt BETWEEN 1430 AND 1430+1000 OR ss_wholesale_cost BETWEEN 32 AND 32+20) ) B2, ( SELECT AVG(ss_list_price) B3_LP, COUNT(ss_list_price) B3_CNT, COUNT(DISTINCT ss_list_price) B3_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 66 AND 66+10 OR ss_coupon_amt BETWEEN 920 AND 920+1000 OR ss_wholesale_cost BETWEEN 4 AND 4+20) ) B3, ( SELECT AVG(ss_list_price) B4_LP, COUNT(ss_list_price) B4_CNT, COUNT(DISTINCT ss_list_price) B4_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 142 AND 142+10 OR ss_coupon_amt BETWEEN 3054 AND 3054+1000 OR ss_wholesale_cost BETWEEN 80 AND 80+20) ) B4, ( SELECT AVG(ss_list_price) B5_LP, COUNT(ss_list_price) B5_CNT, COUNT(DISTINCT ss_list_price) B5_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 135 AND 135+10 OR ss_coupon_amt BETWEEN 14180 AND 14180+1000 OR ss_wholesale_cost BETWEEN 38 AND 38+20) ) B5, ( SELECT AVG(ss_list_price) B6_LP, COUNT(ss_list_price) B6_CNT, COUNT(DISTINCT ss_list_price) B6_CNTD FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 28 AND 28+10 OR ss_coupon_amt BETWEEN 2513 AND 2513+1000 OR ss_wholesale_cost BETWEEN 42 AND 42+20) ) B6 LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q3  - iteration 3'; SELECT d_year, i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) sum_agg FROM etl_sf30000.public.store_sales_denorm WHERE i_manufact_id = 436 AND d_moy=12 GROUP BY d_year, i_brand, i_brand_id ORDER BY d_year, sum_agg DESC, brand_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q36 - iteration 3'; SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING (i_category)+ GROUPING (i_class) AS lochierarchy, rank() OVER ( PARTITION BY GROUPING (i_category)+ GROUPING (i_class), CASE WHEN GROUPING (i_class) = 0 THEN i_category END ORDER BY sum(ss_net_profit)/sum(ss_ext_sales_price) ASC) AS rank_within_parent FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 1999 AND s_state IN ('NE', 'IN', 'SD', 'MN', 'TX', 'MN', 'MI', 'LA') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q6  - iteration 3'; SELECT s.ca_state state, COUNT(*) cnt FROM etl_sf30000.public.store_sales_denorm s WHERE s.d_month_seq = (SELECT DISTINCT (d_month_seq) FROM etl_sf30000.public.store_sales_denorm WHERE d_year = 2000 AND d_moy = 2 ) AND s.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM etl_sf30000.public.store_sales_denorm j WHERE j.i_category = s.i_category ) GROUP BY s.ca_state HAVING count(*) >= 10 ORDER BY cnt, s.ca_state LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q7  - iteration 3'; SELECT i_item_id, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM etl_sf30000.public.store_sales_denorm WHERE cd_gender = 'F' AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 1998 GROUP BY i_item_id ORDER BY i_item_id LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q8  - iteration 3'; SELECT s_store_name, SUM(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm, (SELECT ca_zip FROM (SELECT SUBSTR(ca_zip, 1, 5) ca_zip FROM etl_sf30000.public.store_sales_denorm WHERE substr(ca_zip,1,5) IN ( '89436', '30868', '65085', '22977', '83927', '77557', '58429', '40697', '80614', '10502', '32779', '91137', '61265', '98294', '17921', '18427', '21203', '59362', '87291', '84093', '21505', '17184', '10866', '67898', '25797', '28055', '18377', '80332', '74535', '21757', '29742', '90885', '29898', '17819', '40811', '25990', '47513', '89531', '91068', '10391', '18846', '99223', '82637', '41368', '83658', '86199', '81625', '26696', '89338', '88425', '32200', '81427', '19053', '77471', '36610', '99823', '43276', '41249', '48584', '83550', '82276', '18842', '78890', '14090', '38123', '40936', '34425', '19850', '43286', '80072', '79188', '54191', '11395', '50497', '84861', '90733', '21068', '57666', '37119', '25004', '57835', '70067', '62878', '95806', '19303', '18840', '19124', '29785', '16737', '16022', '49613', '89977', '68310', '60069', '98360', '48649', '39050', '41793', '25002', '27413', '39736', '47208', '16515', '94808', '57648', '15009', '80015', '42961', '63982', '21744', '71853', '81087', '67468', '34175', '64008', '20261', '11201', '51799', '48043', '45645', '61163', '48375', '36447', '57042', '21218', '41100', '89951', '22745', '35851', '83326', '61125', '78298', '80752', '49858', '52940', '96976', '63792', '11376', '53582', '18717', '90226', '50530', '94203', '99447', '27670', '96577', '57856', '56372', '16165', '23427', '54561', '28806', '44439', '22926', '30123', '61451', '92397', '56979', '92309', '70873', '13355', '21801', '46346', '37562', '56458', '28286', '47306', '99555', '69399', '26234', '47546', '49661', '88601', '35943', '39936', '25632', '24611', '44166', '56648', '30379', '59785', '11110', '14329', '93815', '52226', '71381', '13842', '25612', '63294', '14664', '21077', '82626', '18799', '60915', '81020', '56447', '76619', '11433', '13414', '42548', '92713', '70467', '30884', '47484', '16072', '38936', '13036', '88376', '45539', '35901', '19506', '65690', '73957', '71850', '49231', '14276', '20005', '18384', '76615', '11635', '38177', '55607', '41369', '95447', '58581', '58149', '91946', '33790', '76232', '75692', '95464', '22246', '51061', '56692', '53121', '77209', '15482', '10688', '14868', '45907', '73520', '72666', '25734', '17959', '24677', '66446', '94627', '53535', '15560', '41967', '69297', '11929', '59403', '33283', '52232', '57350', '43933', '40921', '36635', '10827', '71286', '19736', '80619', '25251', '95042', '15526', '36496', '55854', '49124', '81980', '35375', '49157', '63512', '28944', '14946', '36503', '54010', '18767', '23969', '43905', '66979', '33113', '21286', '58471', '59080', '13395', '79144', '70373', '67031', '38360', '26705', '50906', '52406', '26066', '73146', '15884', '31897', '30045', '61068', '45550', '92454', '13376', '14354', '19770', '22928', '97790', '50723', '46081', '30202', '14410', '20223', '88500', '67298', '13261', '14172', '81410', '93578', '83583', '46047', '94167', '82564', '21156', '15799', '86709', '37931', '74703', '83103', '23054', '70470', '72008', '49247', '91911', '69998', '20961', '70070', '63197', '54853', '88191', '91830', '49521', '19454', '81450', '89091', '62378', '25683', '61869', '51744', '36580', '85778', '36871', '48121', '28810', '83712', '45486', '67393', '26935', '42393', '20132', '55349', '86057', '21309', '80218', '10094', '11357', '48819', '39734', '40758', '30432', '21204', '29467', '30214', '61024', '55307', '74621', '11622', '68908', '33032', '52868', '99194', '99900', '84936', '69036', '99149', '45013', '32895', '59004', '32322', '14933', '32936', '33562', '72550', '27385', '58049', '58200', '16808', '21360', '32961', '18586', '79307', '15492') INTERSECT SELECT ca_zip FROM (SELECT substr(ca_zip,1,5) ca_zip, count(*) cnt FROM etl_sf30000.public.store_sales_denorm WHERE c_preferred_cust_flag='Y' GROUP BY ca_zip HAVING count(*)> 10) A1 ) A2 ) V1 WHERE d_qoy = 1 AND d_year = 2002 AND (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) GROUP BY s_store_name ORDER BY s_store_name LIMIT 100 ;
ALTER SESSION SET QUERY_TAG = 'etl sf30000 - read 6 - q9  - iteration 3'; SELECT CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) > 48409437 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 1 AND 20 ) END bucket1, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) > 24804257 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 21 AND 40 ) END bucket2, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) > 128048939 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 41 AND 60 ) END bucket3, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) > 56503968 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 61 AND 80 ) END bucket4, CASE WHEN (SELECT COUNT(*) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) > 43571537 THEN (SELECT AVG(ss_ext_discount_amt) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) ELSE (SELECT AVG(ss_net_profit) FROM etl_sf30000.public.store_sales_denorm WHERE ss_quantity BETWEEN 81 AND 100 ) END bucket5 ;

ALTER SESSION SET QUERY_TAG = 'etl sf30000 - write 1 - create table'; 
CREATE TABLE etl_sf30000.public.store_sales_denorm AS 
SELECT * FROM etlprep_sf30000.public.store_sales_denorm_start ;


/* -----------------------
          END
----------------------- */
ALTER WAREHOUSE WH_2XL suspend;
